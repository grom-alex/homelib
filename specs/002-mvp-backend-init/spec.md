# Feature Specification: MVP HomeLib — Бэкенд, импорт каталога и базовый UI

**Feature Branch**: `002-mvp-backend-init`
**Created**: 2026-02-15
**Status**: Draft
**Input**: User description: "На основании архитектуры проекта docs/homelib-architecture-v7.md нужно реализовать первую итерацию, создать MVP проекта"

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Импорт библиотеки из INPX (Priority: P1)

Администратор загружает INPX-файл коллекции через панель управления. Система парсит файл, извлекает метаданные книг, авторов, жанров и серий, сохраняет их в базу данных. После импорта администратор видит статистику: количество добавленных/обновлённых книг, авторов, жанров.

**Why this priority**: Без каталога книг остальные функции бессмысленны. Импорт — это фундамент, на котором строятся все остальные user stories.

**Independent Test**: Запустить систему через Docker Compose, выполнить импорт тестового INPX-файла, убедиться что книги появились в базе данных и доступны через API.

**Acceptance Scenarios**:

1. **Given** система запущена и база данных пуста, **When** администратор запускает импорт INPX-файла, **Then** книги, авторы, жанры и серии сохраняются в базу данных, и отображается статистика импорта.
2. **Given** в базе уже есть книги из предыдущего импорта, **When** администратор импортирует обновлённый INPX, **Then** новые книги добавляются, существующие обновляются (idempotent), дубликаты не создаются.
3. **Given** INPX-файл содержит 600K+ записей, **When** запускается импорт, **Then** процесс завершается за разумное время (менее 5 минут) без ошибок нехватки памяти.
4. **Given** INPX-файл содержит записи с пометкой DEL=1, **When** запускается импорт, **Then** эти книги помечаются как удалённые (is_deleted=true), но не удаляются физически.

---

### User Story 2 — Просмотр каталога книг (Priority: P2)

Пользователь открывает каталог книг и просматривает библиотеку с возможностью фильтрации по автору, жанру, языку и формату. Каталог поддерживает пагинацию и сортировку. Пользователь может открыть карточку книги и увидеть детальную информацию: название, авторы, жанры, серия, аннотация, формат.

**Why this priority**: Просмотр каталога — базовая функция библиотеки. Без неё пользователь не может найти и выбрать книгу.

**Independent Test**: После импорта INPX открыть каталог, применить фильтры, перейти на страницу книги, убедиться что все данные корректно отображаются.

**Acceptance Scenarios**:

1. **Given** каталог содержит книги, **When** пользователь открывает страницу каталога, **Then** отображается список книг с пагинацией (по умолчанию 20 на страницу).
2. **Given** каталог содержит книги разных авторов и жанров, **When** пользователь применяет фильтр по автору, **Then** отображаются только книги выбранного автора.
3. **Given** каталог содержит книги, **When** пользователь открывает карточку конкретной книги, **Then** отображается полная информация: название, авторы, жанры, серия (с номером), язык, формат, размер файла, аннотация (если есть).
4. **Given** каталог содержит книги, **When** пользователь вводит поисковый запрос, **Then** выполняется полнотекстовый поиск по названию и описанию, результаты отображаются с релевантной сортировкой.

---

### User Story 3 — Регистрация и аутентификация (Priority: P3)

Пользователь регистрируется в системе, указывая имя, email и пароль. После регистрации пользователь входит в систему и получает доступ к каталогу. Первый зарегистрированный пользователь автоматически получает роль администратора.

**Why this priority**: Аутентификация необходима для разграничения доступа и персональных функций, но каталог можно тестировать и без неё.

**Independent Test**: Зарегистрировать пользователя, войти, получить access-токен, выполнить запрос к защищённому эндпоинту.

**Acceptance Scenarios**:

1. **Given** в системе нет пользователей, **When** первый пользователь регистрируется, **Then** он получает роль администратора.
2. **Given** регистрация открыта, **When** новый пользователь регистрируется с валидными данными, **Then** аккаунт создаётся с ролью "user", пользователь автоматически входит в систему.
3. **Given** пользователь зарегистрирован, **When** он входит с корректным email и паролем, **Then** система возвращает access-токен (короткоживущий) и устанавливает refresh-токен (долгоживущий).
4. **Given** access-токен истёк, **When** клиент отправляет запрос на обновление с валидным refresh-токеном, **Then** система возвращает новый access-токен.
5. **Given** пользователь не аутентифицирован, **When** он пытается получить доступ к каталогу, **Then** система возвращает ошибку и перенаправляет на страницу входа.

---

### User Story 4 — Скачивание книги (Priority: P4)

Пользователь находит нужную книгу в каталоге и скачивает её. Система извлекает файл из ZIP-архива на лету, без предварительной распаковки.

**Why this priority**: Скачивание — ключевая функция библиотеки, но требует работающего каталога и аутентификации.

**Independent Test**: Найти книгу в каталоге, нажать "Скачать", убедиться что файл скачивается корректно с правильным именем и форматом.

**Acceptance Scenarios**:

1. **Given** книга существует в каталоге и соответствующий ZIP-архив доступен, **When** пользователь запрашивает скачивание, **Then** система извлекает файл из архива и отдаёт его с корректным Content-Type и именем файла.
2. **Given** ZIP-архив с книгой недоступен или повреждён, **When** пользователь запрашивает скачивание, **Then** система возвращает понятное сообщение об ошибке.

---

### User Story 5 — Инфраструктура Docker Compose (Priority: P5)

Администратор разворачивает систему одной командой `docker compose up`. Все компоненты (бэкенд, фронтенд, база данных, nginx) запускаются, база данных мигрируется автоматически.

**Why this priority**: Инфраструктура — необходимое условие для всех остальных stories, но реализуется как отдельная единица для независимого тестирования.

**Independent Test**: Клонировать репозиторий, запустить `docker compose up`, убедиться что все сервисы стартуют и health-check проходят.

**Acceptance Scenarios**:

1. **Given** Docker и Docker Compose установлены, **When** пользователь выполняет `docker compose up`, **Then** все сервисы запускаются без ошибок, миграции БД применяются автоматически.
2. **Given** система запущена, **When** пользователь открывает браузер на адресе сервера, **Then** отображается страница входа/регистрации.
3. **Given** система работала ранее и была остановлена, **When** пользователь выполняет `docker compose up`, **Then** система стартует с сохранёнными данными.

---

### Edge Cases

- Что происходит при импорте повреждённого INPX-файла? Система должна сообщить об ошибке с указанием позиции и характера проблемы, корректно обработанные записи до точки ошибки должны быть сохранены.
- Что происходит при одновременном запуске двух импортов? Система должна предотвратить параллельный импорт и сообщить, что импорт уже выполняется.
- Что происходит при попытке скачать книгу, если путь к архивам не настроен? Система должна вернуть понятное сообщение об ошибке конфигурации (для администратора) и общее сообщение "файл недоступен" для обычного пользователя.
- Что происходит при регистрации с уже существующим email? Система должна вернуть ошибку "пользователь с таким email уже существует".
- Что происходит если INPX содержит записи без обязательных полей (TITLE, FILE)? Такие записи пропускаются с записью предупреждения в лог.

## Clarifications

### Session 2026-02-15

- Q: Требования к покрытию кода тестами? → A: Unit-тесты не менее 80% для каждого Go-пакета. Правило зафиксировано в конституции (v1.2.0) и CLAUDE.md.
- Q: Распространяется ли требование покрытия на фронтенд? → A: Да, покрытие unit-тестами не менее 80% обязательно и для фронтенда (Vue 3). Конституция обновлена до v1.2.1.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА парсить INPX-файлы, извлекая метаданные книг, авторов, жанров и серий, и сохранять их в базу данных.
- **FR-002**: Система ДОЛЖНА поддерживать инкрементальный (idempotent) импорт — повторный импорт того же файла не создаёт дубликатов.
- **FR-003**: Система ДОЛЖНА предоставлять API для просмотра каталога книг с фильтрацией (автор, жанр, язык, формат), пагинацией и сортировкой.
- **FR-004**: Система ДОЛЖНА предоставлять полнотекстовый поиск по каталогу с использованием tsvector.
- **FR-005**: Система ДОЛЖНА поддерживать регистрацию и аутентификацию пользователей через JWT-токены (access + refresh).
- **FR-006**: Система ДОЛЖНА назначать роль администратора первому зарегистрированному пользователю.
- **FR-007**: Система ДОЛЖНА предоставлять возможность скачивания книг с извлечением файлов из ZIP-архивов на лету.
- **FR-008**: Система ДОЛЖНА разворачиваться через Docker Compose одной командой.
- **FR-009**: Система ДОЛЖНА автоматически применять миграции базы данных при первом запуске.
- **FR-010**: Система ДОЛЖНА предоставлять базовый веб-интерфейс для просмотра каталога, входа/регистрации и управления импортом.
- **FR-011**: Система ДОЛЖНА обрабатывать поля INPX: AUTHOR, GENRE, TITLE, SERIES, SERNO, FILE, SIZE, LIBID, DEL, EXT, DATE, LANG, LIBRATE, KEYWORDS, FOLDER.
- **FR-012**: Система ДОЛЖНА корректно парсить авторов (формат "Фамилия,Имя,Отчество:", несколько авторов через ":"), жанры (через ":"), серии (с типом [a]/[p]).
- **FR-013**: Система ДОЛЖНА поддерживать полнотекстовый поиск с учётом русского и английского языков.
- **FR-014**: Система ДОЛЖНА предотвращать параллельный запуск импорта.
- **FR-015**: Код бэкенда и фронтенда ДОЛЖЕН иметь покрытие unit-тестами не менее 80% для каждого пакета/модуля.

### Key Entities

- **Книга (Book)**: Основная сущность каталога. Содержит название, язык, год, формат, размер, ссылку на архив/файл, аннотацию, ключевые слова. Связана с авторами, жанрами и серией через M:N и FK связи.
- **Автор (Author)**: Имя (фамилия, имя, отчество) с сортируемым представлением. Связан с книгами через M:N.
- **Жанр (Genre)**: Код и человекочитаемое название. Иерархическая структура (parent_id). Связан с книгами через M:N.
- **Серия (Series)**: Название серии. Книги в серии имеют номер и тип (авторская/издательская).
- **Коллекция (Collection)**: Метаданные импортированной библиотеки — название, код, версия, количество книг.
- **Пользователь (User)**: Email, имя, хеш пароля, роль (user/admin), настройки.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Импорт INPX-файла с 600K+ записями завершается менее чем за 5 минут.
- **SC-002**: Страница каталога с фильтрацией загружается менее чем за 1 секунду при каталоге в 600K книг.
- **SC-003**: Система разворачивается из чистого репозитория до рабочего состояния одной командой `docker compose up` менее чем за 3 минуты.
- **SC-004**: Все API-эндпоинты возвращают корректные HTTP-коды и структурированные JSON-ответы.
- **SC-005**: Полнотекстовый поиск возвращает релевантные результаты для запросов на русском и английском языках.
- **SC-006**: Скачивание книги из ZIP-архива происходит без задержки, заметной пользователю (менее 2 секунд для файлов до 10 MB).
- **SC-007**: Покрытие unit-тестами составляет не менее 80% для каждого пакета/модуля (бэкенд Go и фронтенд Vue 3).

## Assumptions

- INPX-файл и ZIP-архивы с книгами доступны на сервере по пути, указанному в конфигурации (read-only volume).
- Для MVP семантический поиск (pgvector, Ollama) НЕ реализуется — только полнотекстовый и нечёткий поиск.
- Для MVP чтение книг в браузере НЕ реализуется — только скачивание.
- Для MVP персональные функции (полки, статусы, прогресс чтения) НЕ реализуются — только просмотр каталога.
- Frontend в MVP реализуется минимально — достаточно функциональный, но без полного дизайна.
- LLM-саммаризация и embedding pipeline НЕ входят в MVP.
- Ollama Pool НЕ настраивается в MVP.
- Извлечение обложек и аннотаций из файлов книг НЕ входит в MVP — используются только данные из INPX.
