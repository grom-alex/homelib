# Feature Specification: Скрипты сборки и деплоя

**Feature Branch**: `003-build-deploy-scripts`
**Created**: 2026-02-17
**Status**: Draft
**Input**: Добавлены новые скрипты сборки и деплоя в папку scripts. Просмотреть примеры из kids-accounting и применить к текущему проекту.

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Локальная сборка Docker-образов (Priority: P1)

Разработчик хочет собрать все Docker-образы проекта (API, Worker, Frontend) одной командой на локальной машине, чтобы проверить работоспособность перед пушем в репозиторий.

**Why this priority**: Без локальной сборки невозможно проверить, что изменения в коде корректно упаковываются в контейнеры. Это базовая операция для любого участника проекта.

**Independent Test**: Разработчик запускает `./scripts/build-local.sh` и получает собранные образы, проверяемые через `docker images`.

**Acceptance Scenarios**:

1. **Given** чистый репозиторий, **When** разработчик запускает `./scripts/build-local.sh`, **Then** собираются все 3 образа (api, worker, frontend) с тегом по умолчанию
2. **Given** разработчик указывает `--component backend`, **When** скрипт выполняется, **Then** собираются только образы api и worker
3. **Given** Docker не установлен, **When** скрипт запускается, **Then** выводится понятное сообщение об ошибке и скрипт завершается с ненулевым кодом
4. **Given** сборка одного из образов завершается с ошибкой, **When** скрипт работает, **Then** ошибка логируется, остальные образы не собираются

---

### User Story 2 — Деплой в локальное/staging/production окружение (Priority: P1)

Администратор хочет разворачивать проект в указанное окружение (dev/stage/prod) одной командой с автоматической проверкой доступности сервисов после деплоя.

**Why this priority**: Деплой — ключевая операция для доставки продукта. Без автоматизации каждый деплой чреват ошибками и занимает лишнее время.

**Independent Test**: Администратор запускает `./scripts/deploy-local.sh` и сервисы поднимаются с проверкой health check.

**Acceptance Scenarios**:

1. **Given** корректный `.env` файл, **When** администратор запускает `./scripts/deploy-local.sh`, **Then** сервисы поднимаются через Docker Compose и проходят health check
2. **Given** окружение staging с SSH-доступом, **When** запускается `./scripts/deploy-stage.sh -t TAG -h HOST`, **Then** образы доставляются на сервер, контейнеры перезапускаются, health check проходит
3. **Given** health check не проходит после деплоя, **When** скрипт проверяет доступность, **Then** выводится ошибка с диагностической информацией
4. **Given** отсутствует `.env` файл, **When** запускается деплой, **Then** скрипт сообщает о недостающей конфигурации и не продолжает

---

### User Story 3 — Сборка и публикация образов в Docker Registry (Priority: P2)

Разработчик хочет собрать образы, прогнать тесты и опубликовать образы в Docker Registry с корректными тегами для дальнейшего деплоя.

**Why this priority**: Публикация образов необходима для деплоя на удалённые серверы (staging/production), но менее приоритетна, чем базовая сборка и локальный деплой.

**Independent Test**: Разработчик запускает `./scripts/build-and-push.sh v1.0.0`, тесты проходят, образы пушатся в registry с нужными тегами.

**Acceptance Scenarios**:

1. **Given** тесты проходят, **When** запускается `./scripts/build-and-push.sh v1.0.0`, **Then** образы собираются и пушатся с тегами `v1.0.0`, `sha-<hash>` и `latest`
2. **Given** тесты падают, **When** запускается скрипт, **Then** сборка и публикация не выполняются, выводится сообщение об ошибке
3. **Given** Docker Registry недоступен, **When** скрипт пытается запушить, **Then** выводится сообщение об ошибке подключения

---

### User Story 4 — Единая библиотека утилит для всех скриптов (Priority: P2)

Все скрипты должны использовать общие библиотеки (логирование, проверка зависимостей, Docker-операции) для единообразного поведения и упрощения поддержки.

**Why this priority**: Без общих библиотек каждый скрипт дублирует логику, усложняя поддержку и создавая несогласованное поведение.

**Independent Test**: Любой скрипт, использующий `lib/logging.sh`, выводит единообразные сообщения с цветами, уровнями и временными метками.

**Acceptance Scenarios**:

1. **Given** скрипт подключает `lib/logging.sh`, **When** вызывается `log_info "message"`, **Then** выводится сообщение с меткой `[INFO]`, временной меткой и цветом
2. **Given** скрипт подключает `lib/prerequisites.sh`, **When** вызывается `check_docker`, **Then** проверяется наличие и работоспособность Docker, при отсутствии — понятное сообщение об ошибке
3. **Given** скрипт подключает `lib/docker-utils.sh`, **When** вызывается `build_image`, **Then** образ собирается с логированием прогресса

---

### User Story 5 — Удалённый деплой на production (Priority: P3)

Администратор хочет безопасно деплоить на production-сервер через SSH с автоматическим бэкапом текущего состояния.

**Why this priority**: Production-деплой критичен для доставки, но выполняется реже и требует больше контроля. Staging-деплой (US2) покрывает большинство сценариев.

**Independent Test**: Администратор запускает `./scripts/deploy-prod.sh -t v1.0.0 -h prod.server`, на сервере обновляются контейнеры.

**Acceptance Scenarios**:

1. **Given** SSH-доступ к серверу, **When** запускается `./scripts/deploy-prod.sh -t TAG -h HOST`, **Then** текущее состояние бэкапится, образы обновляются, health check проходит
2. **Given** SSH-соединение не устанавливается, **When** запускается скрипт, **Then** выводится ошибка, деплой не выполняется
3. **Given** флаг `--dry-run`, **When** запускается скрипт, **Then** выводится план действий без фактического выполнения

---

### Edge Cases

- Что происходит при прерывании скрипта (Ctrl+C) во время сборки или деплоя?
- Как скрипты ведут себя при нехватке дискового пространства?
- Что происходит при одновременном запуске двух скриптов деплоя?
- Как обрабатывается ситуация, когда порты уже заняты другими процессами?
- Что происходит при потере сетевого соединения во время удалённого деплоя?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Все скрипты MUST использовать `set -euo pipefail` для строгой обработки ошибок
- **FR-002**: Все скрипты MUST поддерживать флаг `--help` с описанием использования
- **FR-003**: Все скрипты MUST использовать общие библиотеки из `scripts/lib/` для логирования, проверки зависимостей и Docker-операций
- **FR-004**: Скрипты MUST использовать единую систему кодов завершения: 0 — успех, 1 — ошибка зависимостей, 2 — ошибка выполнения
- **FR-005**: Скрипты деплоя MUST проверять наличие `.env` файла или обязательных переменных окружения перед началом работы
- **FR-006**: Скрипты деплоя MUST выполнять health check после запуска сервисов
- **FR-007**: Библиотека логирования MUST поддерживать уровни: DEBUG, INFO, SUCCESS, WARN, ERROR, FATAL с цветовым выделением
- **FR-008**: Библиотека проверки зависимостей MUST валидировать наличие Docker, Docker Compose, Go, Node.js с проверкой минимальных версий
- **FR-009**: Скрипт `build-local.sh` MUST поддерживать выборочную сборку компонентов (backend, frontend, all)
- **FR-010**: Скрипт `build-and-push.sh` MUST прогонять тесты перед сборкой и блокировать публикацию при неуспешных тестах
- **FR-011**: Скрипты удалённого деплоя MUST проверять SSH-соединение перед началом работы
- **FR-012**: Скрипт `deploy-prod.sh` MUST поддерживать `--dry-run` для предварительного просмотра действий
- **FR-013**: Все скрипты MUST быть адаптированы к структуре HomeLib (3 Docker-образа: api, worker, frontend; Docker Compose файлы в `docker/`)
- **FR-014**: Существующие утилитарные скрипты (backup-db, restore-db, import-inpx, migrate, dev-setup) MUST быть обновлены для использования общих библиотек из `scripts/lib/`

## Assumptions

- Docker Registry для публикации образов настраивается через переменные окружения (`DOCKER_REGISTRY`, `IMAGE_PREFIX`)
- SSH-деплой использует стандартную аутентификацию по ключам (настроенную заранее)
- HomeLib развёрнут в хоумлабе — один сервер, один администратор
- Скрипты ориентированы на Linux/macOS; Windows-поддержка через WSL
- Старый `deploy.sh` переименован в `deploy-old.sh` для обратной совместимости на переходный период

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Разработчик может собрать все Docker-образы одной командой менее чем за 5 минут (при наличии кэша)
- **SC-002**: Деплой в локальное окружение занимает не более 2 минут от запуска скрипта до прохождения health check
- **SC-003**: 100% скриптов имеют `--help` с описанием всех параметров
- **SC-004**: При ошибке зависимостей (Docker не установлен и т.п.) скрипт выводит понятное сообщение с инструкцией по исправлению
- **SC-005**: Все скрипты используют единую библиотеку логирования — нет дублирования кода вывода сообщений
- **SC-006**: Удалённый деплой на staging/production выполняется без ручных промежуточных действий (один скрипт от начала до конца)
