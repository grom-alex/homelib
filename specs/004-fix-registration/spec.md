# Feature Specification: Fix User Registration

**Feature Branch**: `004-fix-registration`
**Created**: 2026-02-18
**Status**: Draft
**Input**: User description: "Ошибка регистрации первого пользователя на стейдже — registration failed (500)"

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Регистрация первого пользователя (Priority: P1)

Первый пользователь открывает HomeLib, переходит на вкладку "Регистрация", заполняет форму (email, username, отображаемое имя, пароль) и нажимает "Зарегистрироваться". Система создаёт пользователя с ролью `admin` и автоматически выполняет вход.

**Why this priority**: Без работающей регистрации система полностью неработоспособна — ни один пользователь не может получить доступ.

**Independent Test**: Можно проверить на чистой БД — отправить POST `/api/auth/register` и получить `201 Created` с токенами.

**Acceptance Scenarios**:

1. **Given** пустая БД (0 пользователей), **When** пользователь отправляет валидный запрос на регистрацию, **Then** система создаёт пользователя с ролью `admin`, возвращает `201` с `access_token` и `user`, устанавливает `refresh_token` cookie.
2. **Given** пустая БД, **When** два запроса на регистрацию приходят одновременно, **Then** только один получает роль `admin`, второй — роль `user` (race condition предотвращён).
3. **Given** существующий пользователь, **When** регистрация с тем же email или username, **Then** система возвращает `409 Conflict`.

---

### User Story 2 — Информативное логирование ошибок (Priority: P2)

При ошибке регистрации сервер логирует причину для отладки. Пользователь видит безопасное сообщение без деталей реализации.

**Why this priority**: Улучшает отладку и ускоряет диагностику проблем, но не блокирует основную функциональность.

**Independent Test**: Вызвать ситуацию ошибки и проверить наличие записи в логах сервера.

**Acceptance Scenarios**:

1. **Given** валидный запрос на регистрацию, **When** происходит внутренняя ошибка, **Then** ошибка логируется на сервере с контекстом (текст ошибки, операция), а пользователю возвращается безопасное сообщение.

---

### Edge Cases

- Что происходит при одновременной регистрации двух пользователей (race condition для роли первого админа)?
- Как система ведёт себя при `registration_enabled: false` и 0 пользователей? (Первый пользователь должен регистрироваться всегда.)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА позволять регистрацию первого пользователя на чистой БД, присваивая ему роль `admin`.
- **FR-002**: Система ДОЛЖНА предотвращать race condition при определении первого пользователя (атомарная проверка и вставка).
- **FR-003**: SQL-запрос блокировки таблицы `users` НЕ ДОЛЖЕН использовать `FOR UPDATE` с агрегатными функциями (несовместимо с PostgreSQL).
- **FR-004**: Система ДОЛЖНА логировать внутренние ошибки регистрации на сервере для отладки.

### Root Cause

Ошибка в `backend/internal/repository/user.go:81`:

```sql
SELECT COUNT(*) FROM users FOR UPDATE
```

PostgreSQL возвращает ошибку `SQLSTATE 0A000`: `FOR UPDATE is not allowed with aggregate functions`. Запрос использует `COUNT(*)` (агрегат) вместе с `FOR UPDATE` (блокировка строк), что запрещено.

### Key Entities

- **User**: Пользователь системы (email, username, display_name, password_hash, role). Первый зарегистрированный получает роль `admin`.
- **RefreshToken**: Токен обновления привязанный к пользователю (token_hash, expires_at).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Регистрация первого пользователя завершается успешно (HTTP 201) на чистой БД.
- **SC-002**: Все существующие unit-тесты проходят после исправления.
- **SC-003**: Новые тесты покрывают сценарии: первый пользователь (admin), второй пользователь (user), дубликат email/username.
- **SC-004**: Race condition при одновременной регистрации не приводит к двум администраторам.

## Assumptions

- Исправление затрагивает только SQL-запрос в repository layer — замена `SELECT COUNT(*) FROM users FOR UPDATE` на PostgreSQL-совместимый вариант блокировки.
- Дополнительно: добавить серверное логирование ошибок регистрации для ускорения отладки в будущем.
