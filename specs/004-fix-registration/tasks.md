# Tasks: Fix User Registration

**Input**: Design documents from `/specs/004-fix-registration/`
**Prerequisites**: plan.md, spec.md, research.md, quickstart.md

**Tests**: –í–∫–ª—é—á–µ–Ω—ã ‚Äî spec.md —Ç—Ä–µ–±—É–µ—Ç unit-—Ç–µ—Å—Ç—ã (SC-003), CLAUDE.md —Ç—Ä–µ–±—É–µ—Ç 80% –ø–æ–∫—Ä—ã—Ç–∏–µ.

**Organization**: –ó–∞–¥–∞—á–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ user story –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã, –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- **[Story]**: –ö –∫–∞–∫–æ–º—É user story –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∑–∞–¥–∞—á–∞ (US1, US2)
- –£–∫–∞–∑–∞–Ω—ã —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤

---

## Phase 1: User Story 1 ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Priority: P1) üéØ MVP

**Goal**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –≤ `RegisterUser` ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å `SELECT COUNT(*) FROM users FOR UPDATE` –Ω–∞ `LOCK TABLE users IN EXCLUSIVE MODE` + `SELECT COUNT(*)`. –ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å `admin`, race condition –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω.

**Independent Test**: –ù–∞ —á–∏—Å—Ç–æ–π –ë–î ‚Äî POST `/api/auth/register` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `201 Created` —Å `role: admin`.

### Tests for User Story 1 ‚ö†Ô∏è

> **NOTE: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –ü–ï–†–í–´–ú–ò, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∏ FAIL –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

- [X] T001 [US1] –°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è `RegisterUser` –≤ `backend/internal/repository/user_test.go` ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–∏: –ø–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç `admin`, –≤—Ç–æ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç `user`, –¥—É–±–ª–∏–∫–∞—Ç email/username –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, `registration_enabled: false` —Å `count > 0` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, `registration_enabled: false` —Å `count == 0` —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

### Implementation for User Story 1

- [X] T002 [US1] –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL –≤ `RegisterUser` –≤ `backend/internal/repository/user.go:79-84` ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å `SELECT COUNT(*) FROM users FOR UPDATE` –Ω–∞ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞: `LOCK TABLE users IN EXCLUSIVE MODE` (—á–µ—Ä–µ–∑ `tx.Exec`) –∏ `SELECT COUNT(*) FROM users` (—á–µ—Ä–µ–∑ `tx.QueryRow`)

**Checkpoint**: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md (—à–∞–≥–∏ 1-3).

---

## Phase 2: User Story 2 ‚Äî –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ (Priority: P2)

**Goal**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–∏—á–∏–Ω—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

**Independent Test**: –í—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ stdout/stderr API-—Å–µ—Ä–≤–µ—Ä–∞.

### Implementation for User Story 2

- [X] T003 [US2] –î–æ–±–∞–≤–∏—Ç—å `log.Printf` –≤ `default` –≤–µ—Ç–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –º–µ—Ç–æ–¥–∞ `Register` –≤ `backend/internal/api/handler/auth.go:41-42` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π generic-–æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É

**Checkpoint**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ª–æ–≥–∞—Ö API –≤–∏–¥–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞.

---

## Phase 3: Polish & Verification

**Purpose**: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤

- [X] T004 –ó–∞–ø—É—Å—Ç–∏—Ç—å unit-—Ç–µ—Å—Ç—ã: `cd backend && go test -race -v ./internal/repository/... ./internal/api/handler/...`
- [X] T005 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md ‚Äî –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å API, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å race condition (—à–∞–≥–∏ 1-3)

---

## Dependencies & Execution Order

### Phase Dependencies

- **Phase 1 (US1)**: –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É
- **Phase 2 (US2)**: –ù–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç Phase 1 ‚Äî –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: `user.go` vs `auth.go`)
- **Phase 3 (Polish)**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Phase 1 –∏ Phase 2

### Within User Story 1

- T001 (—Ç–µ—Å—Ç—ã) ‚Üí T002 (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ‚Äî —Ç–µ—Å—Ç—ã –ø–∏—à—É—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏

### Parallel Opportunities

- T001 –∏ T003 –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: `user_test.go` vs `auth.go`)
- T002 –∑–∞–≤–∏—Å–∏—Ç –æ—Ç T001 (TDD: —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞)

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. T001: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `RegisterUser` ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ fail
2. T002: –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL –≤ `RegisterUser` ‚Üí —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
3. **STOP –∏ VALIDATE**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ quickstart.md
4. –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ US2

### Incremental Delivery

1. US1 (T001‚ÜíT002) ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –º–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å
2. US2 (T003) ‚Üí –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π
3. Polish (T004‚ÜíT005) ‚Üí –ü–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

---

## Notes

- –í—Å–µ–≥–æ **3 —Ñ–∞–π–ª–∞** –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã: `user.go` (modify), `auth.go` (modify), `user_test.go` (new)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ: 2 —Å—Ç—Ä–æ–∫–∏ SQL –≤ `user.go`, 1 —Å—Ç—Ä–æ–∫–∞ `log.Printf` –≤ `auth.go`
- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç pgxpool mock –∏–ª–∏ testcontainers –¥–ª—è PostgreSQL
- –ö–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
