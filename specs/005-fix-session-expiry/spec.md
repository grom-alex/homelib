# Feature Specification: Исправление истечения сессии

**Feature Branch**: `005-fix-session-expiry`
**Created**: 2026-02-18
**Status**: Draft
**Input**: После входа в интерфейс и простоя в течении нескольких минут при попытках нажать на что либо, появляется красная надпись "Request failed with status code 401" и больше ничего не возможно сделать. При нажатии "Выход" пропадают все пункты меню. Нужно исправить: по окончании сессии выбрасывать на экран входа с возвратом в прежнее место. Время жизни сессии увеличить до пары часов.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Прозрачное продление сессии при активной работе (Priority: P1)

Пользователь входит в систему и работает с каталогом — просматривает книги, фильтрует, переходит по страницам. Сессия автоматически продлевается в фоне без каких-либо видимых прерываний. Пользователь не должен замечать технического процесса обновления токенов — интерфейс всегда остаётся отзывчивым и функциональным.

**Why this priority**: Это корневая проблема — сейчас при истечении короткоживущего токена интерфейс полностью перестаёт работать, показывая ошибки 401. Без исправления этой проблемы приложение непригодно для нормального использования.

**Independent Test**: Войти в систему, подождать дольше времени жизни короткоживущего токена, выполнить любое действие (переключить страницу, применить фильтр). Действие должно выполниться без ошибок.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован и короткоживущий токен истёк, **When** пользователь нажимает на любой элемент интерфейса (меню, фильтр, пагинация), **Then** система прозрачно обновляет токен и выполняет запрошенное действие без показа ошибок
2. **Given** пользователь авторизован и одновременно отправлено несколько запросов с истёкшим токеном, **When** система обнаруживает 401 на первом запросе, **Then** все ожидающие запросы ставятся в очередь, токен обновляется один раз, и все запросы повторяются с новым токеном
3. **Given** пользователь авторизован и непрерывно работает в течение нескольких часов, **When** короткоживущий токен истекает многократно, **Then** каждый раз сессия прозрачно продлевается без вмешательства пользователя

---

### User Story 2 - Редирект на страницу входа при полном истечении сессии (Priority: P2)

Пользователь оставил приложение открытым на длительное время (дольше времени жизни долгоживущей сессии) и вернулся к работе. Вместо непонятных ошибок 401 система плавно перенаправляет его на экран входа. После повторного входа пользователь возвращается на ту же страницу, где он находился до этого.

**Why this priority**: Даже при работающем автоматическом продлении, долгоживущая сессия когда-нибудь истечёт. Пользователь должен получить понятное поведение вместо красных ошибок и "сломанного" интерфейса.

**Independent Test**: Войти в систему, дождаться полного истечения сессии (или имитировать его), попытаться выполнить действие. Система должна перенаправить на страницу входа. После входа — вернуть на исходную страницу.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице каталога и сессия полностью истекла (обновление токена невозможно), **When** пользователь нажимает на любой элемент, **Then** система перенаправляет на страницу входа без показа ошибки 401
2. **Given** пользователь перенаправлен на страницу входа из-за истечения сессии, **When** пользователь вводит логин и пароль, **Then** после успешного входа система возвращает его на ту страницу, где он находился до выхода
3. **Given** пользователь находится на странице с фильтрами и параметрами в адресной строке, **When** сессия истекает и пользователь перелогинивается, **Then** система возвращает его на ту же страницу с теми же параметрами (фильтры, страница пагинации, поисковый запрос)
4. **Given** пользователь нажимает кнопку "Выход" в меню, **When** выполняется разлогинивание, **Then** все элементы интерфейса корректно скрываются и отображается экран входа без сломанного состояния меню

---

### User Story 3 - Увеличение времени жизни сессии (Priority: P3) — ОТМЕНЕНА

> **Решение**: Увеличение TTL до 2 часов отменено. Access token TTL остаётся 15 минут.
> Auto-refresh через httpOnly cookie работает прозрачно, поэтому увеличение не требуется.
> Пользователь не замечает обновления токена — см. US1.

~~Администратор системы хочет, чтобы активно работающие пользователи не были вынуждены перелогиниваться слишком часто. Время жизни короткоживущего токена должно быть увеличено до 2 часов, чтобы при обычной работе обновление происходило значительно реже.~~

---

### Edge Cases

- Что происходит при потере сетевого соединения во время обновления токена? Система должна показать понятное сообщение о проблеме с сетью, а не ошибку 401
- Что происходит, если пользователь открыл приложение в нескольких вкладках и сессия истекла? Все вкладки должны перенаправить на страницу входа
- Что происходит при одновременном запросе обновления токена из нескольких параллельных запросов? Должен выполняться только один запрос обновления, остальные ждут результата
- Что происходит, если сервер временно недоступен (5xx ошибки) — система НЕ должна воспринимать это как истечение сессии и НЕ должна перенаправлять на страницу входа
- Что происходит, если пользователь нажимает "Выход" в момент, когда интерфейс находится в состоянии ошибки? Выход должен корректно очистить состояние и показать страницу входа

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА автоматически обновлять короткоживущий токен при получении ответа 401 от сервера, прозрачно для пользователя
- **FR-002**: Система ДОЛЖНА ставить в очередь все параллельные запросы, получившие 401, и выполнять обновление токена только один раз, после чего повторить все запросы с новым токеном
- **FR-003**: При невозможности обновить токен (долгоживущая сессия истекла) система ДОЛЖНА перенаправить пользователя на страницу входа без показа технических ошибок (статус-кодов, сообщений об ошибках)
- **FR-004**: Система ДОЛЖНА сохранять полный путь текущей страницы (включая параметры запроса) перед перенаправлением на страницу входа и восстанавливать его после успешной авторизации
- **FR-005**: ~~Время жизни короткоживущего токена ДОЛЖНО составлять 2 часа~~ — ОТМЕНЕНА. TTL остаётся 15 минут
- **FR-006**: Кнопка "Выход" ДОЛЖНА корректно работать в любом состоянии интерфейса — очищать данные сессии, скрывать авторизованные элементы интерфейса и показывать страницу входа
- **FR-007**: Система НЕ ДОЛЖНА перенаправлять на страницу входа при серверных ошибках (5xx) — только при ошибках аутентификации (401)
- **FR-008**: Система ДОЛЖНА различать ошибки сети/сервера и ошибки аутентификации и показывать соответствующие сообщения пользователю

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может работать с приложением непрерывно без видимых прерываний или ошибок аутентификации (auto-refresh прозрачен)
- **SC-002**: После истечения полной сессии пользователь перенаправляется на страницу входа в течение 2 секунд после первого действия, без показа ошибок 401
- **SC-003**: После повторного входа пользователь возвращается на ту же страницу с теми же параметрами в 100% случаев
- **SC-004**: Кнопка "Выход" корректно завершает сеанс и отображает страницу входа при любом состоянии интерфейса
- **SC-005**: Unit-тесты покрывают не менее 80% кода, связанного с обновлением токенов и обработкой ошибок аутентификации

### Assumptions

- Текущий механизм автоматического обновления токенов на фронтенде реализован, но содержит дефект, мешающий корректной работе — необходимо исследовать и устранить конкретную причину
- Бэкенд эндпоинт обновления токенов (`/api/auth/refresh`) работает корректно (если нет — необходимо исправить)
- Время жизни долгоживущей сессии (refresh token) остаётся 30 дней — увеличение касается только короткоживущего токена
- Приложение рассчитано на единицы одновременных пользователей (домашняя библиотека), поэтому активное использование кеширования токенов не критично
