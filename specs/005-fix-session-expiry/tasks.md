# Tasks: Fix Session Expiry

**Input**: Design documents from `/specs/005-fix-session-expiry/`
**Prerequisites**: plan.md, spec.md, research.md, quickstart.md

**Tests**: –í–∫–ª—é—á–µ–Ω—ã ‚Äî –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è ¬ß7 TDD —Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç—ã –ø–µ—Ä–≤—ã–º–∏ –¥–ª—è –±–∞–≥-—Ñ–∏–∫—Å–æ–≤, spec SC-005 —Ç—Ä–µ–±—É–µ—Ç 80% –ø–æ–∫—Ä—ã—Ç–∏–µ.

**Organization**: –ó–∞–¥–∞—á–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ user story –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã, –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- **[Story]**: –ö –∫–∞–∫–æ–º—É user story –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∑–∞–¥–∞—á–∞ (US1, US2, US3)
- –£–∫–∞–∑–∞–Ω—ã —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤

---

## Phase 1: User Story 1 ‚Äî –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (Priority: P1) üéØ MVP

**Goal**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–∏—á–∏–Ω—É (cookie_secure –ø—Ä–∏ HTTP) –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é interceptor —Å Pinia store –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º refresh. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ auto-refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ.

**Independent Test**: –í–æ–π—Ç–∏, –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏—Å—Ç–µ—á–µ–Ω–∏—è access token, –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫ 401.

### Tests for User Story 1 ‚ö†Ô∏è

> **NOTE: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –ü–ï–†–í–´–ú–ò, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∏ FAIL –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

- [X] T001 [P] [US1] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –≤ `frontend/src/api/__tests__/client.test.ts` ‚Äî –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º refresh interceptor –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π onAuthExpired callback –ø–µ—Ä–µ–¥ router.push
- [X] T002 [P] [US1] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –≤ `frontend/src/stores/__tests__/auth.test.ts` ‚Äî store –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç onAuthExpired callback —á–µ—Ä–µ–∑ `setOnAuthExpired`, –∏ –ø—Ä–∏ –µ–≥–æ –≤—ã–∑–æ–≤–µ –æ—á–∏—â–∞–µ—Ç auth state (user=null, accessToken=null)

### Implementation for User Story 1

- [X] T003 [P] [US1] –ò—Å–ø—Ä–∞–≤–∏—Ç—å `config/config.stage.yaml:19` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å `cookie_secure: true` –Ω–∞ `cookie_secure: false` (–∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞: Secure cookie –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–∞ HTTP)
- [X] T004 [US1] –î–æ–±–∞–≤–∏—Ç—å callback-–º–µ—Ö–∞–Ω–∏–∑–º –≤ `frontend/src/api/client.ts` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `setOnAuthExpired(callback: () => void)`, –≤ catch-–±–ª–æ–∫–µ interceptor (—Å—Ç—Ä–æ–∫–∞ ~78) –≤—ã–∑–≤–∞—Ç—å callback –ø–µ—Ä–µ–¥ `router.push({ name: 'login' })`
- [X] T005 [US1] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å callback –≤ `frontend/src/stores/auth.ts` ‚Äî –≤ —Ç–µ–ª–µ `defineStore` –≤—ã–∑–≤–∞—Ç—å `setOnAuthExpired(() => clearAuth())` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ store –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

**Checkpoint**: Refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç–µ–π–¥–∂–∏–Ω–≥–µ, store –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ refresh. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md (—à–∞–≥–∏ 3, 4).

---

## Phase 2: User Story 2 ‚Äî –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login + –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ (Priority: P2)

**Goal**: –ü—Ä–∏ –ø–æ–ª–Ω–æ–º –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ URL. –ü–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ö–Ω–æ–ø–∫–∞ "–í—ã—Ö–æ–¥" —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

**Independent Test**: –£–¥–∞–ª–∏—Ç—å cookie refresh_token –≤ DevTools, –Ω–∞–∂–∞—Ç—å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç ‚Üí redirect –Ω–∞ `/login?redirect=...`. –í–æ–π—Ç–∏ ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.

### Tests for User Story 2 ‚ö†Ô∏è

> **NOTE: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –ü–ï–†–í–´–ú–ò, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∏ FAIL –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

- [X] T006 [P] [US2] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –≤ `frontend/src/api/__tests__/client.test.ts` ‚Äî –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º refresh interceptor –≤—ã–∑—ã–≤–∞–µ—Ç `router.push` —Å query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `redirect`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Ç–µ–∫—É—â–∏–π fullPath

### Implementation for User Story 2

- [X] T007 [US2] –û–±–Ω–æ–≤–∏—Ç—å interceptor –≤ `frontend/src/api/client.ts` (—Å—Ç—Ä–æ–∫–∞ ~81) ‚Äî –ø–µ—Ä–µ–¥–∞—Ç—å `query: { redirect: router.currentRoute.value.fullPath }` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `router.push({ name: 'login' })`
- [X] T008 [US2] –û–±–Ω–æ–≤–∏—Ç—å `frontend/src/views/LoginView.vue` ‚Äî –≤ `handleLogin` –∏ `handleRegister` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –Ω–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ `route.query.redirect` (–µ—Å–ª–∏ –µ—Å—Ç—å) –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–Ω–æ–≥–æ `/books`
- [X] T009 [US2] –ò—Å–ø—Ä–∞–≤–∏—Ç—å `handleLogout` –≤ `frontend/src/components/AppHeader.vue` ‚Äî –æ–±–µ—Ä–Ω—É—Ç—å –≤ try/catch, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `clearAuth()` –∏ `router.push('/login')` –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ (–≤–∫–ª—é—á–∞—è –æ—à–∏–±–∫–∏ API)

**Checkpoint**: Redirect-back —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–Ω–æ–ø–∫–∞ "–í—ã—Ö–æ–¥" –Ω–µ –ª–æ–º–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md (—à–∞–≥–∏ 4, 5).

---

## Phase 3: User Story 3 ‚Äî –£–≤–µ–ª–∏—á–µ–Ω–∏–µ TTL –¥–æ 2 —á–∞—Å–æ–≤ (Priority: P3)

**Goal**: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ access token —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 2 —á–∞—Å–æ–≤. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ refresh –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.

**Independent Test**: `grep access_token_ttl config/*.yaml` ‚Äî –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `2h`.

### Implementation for User Story 3

- [X] T010 [P] [US3] –ò–∑–º–µ–Ω–∏—Ç—å `access_token_ttl` —Å `"15m"` –Ω–∞ `"2h"` –≤ `config/config.dev.yaml`, `config/config.stage.yaml`, `config/config.prod.yaml`
- [X] T011 [US3] –ò–∑–º–µ–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç `AccessTokenTTL` —Å `15 * time.Minute` –Ω–∞ `2 * time.Hour` –≤ `backend/internal/config/config.go:79`

**Checkpoint**: –í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç TTL 2h. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md (—à–∞–≥ 6).

---

## Phase 4: Polish & Verification

**Purpose**: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤

- [X] T012 –ó–∞–ø—É—Å—Ç–∏—Ç—å frontend —Ç–µ—Å—Ç—ã: `cd frontend && npx vitest run` ‚Äî 84 —Ç–µ—Å—Ç–æ–≤, –≤—Å–µ –ø—Ä–æ—à–ª–∏
- [X] T013 –ó–∞–ø—É—Å—Ç–∏—Ç—å backend —Ç–µ—Å—Ç—ã: `cd backend && go test -race -v ./...` ‚Äî –≤—Å–µ –ø—Ä–æ—à–ª–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω config_test.go –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–µ—Ñ–æ–ª—Ç–∞ TTL)
- [ ] T014 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ quickstart.md ‚Äî –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å refresh-flow –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—à–∞–≥–∏ 3-7)

---

## Dependencies & Execution Order

### Phase Dependencies

- **Phase 1 (US1)**: –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É
- **Phase 2 (US2)**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç T004 (callback-–º–µ—Ö–∞–Ω–∏–∑–º –≤ client.ts), –Ω–æ T006-T009 –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å T005
- **Phase 3 (US3)**: –ù–µ–∑–∞–≤–∏—Å–∏–º ‚Äî –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å Phase 1 –∏ 2 (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: config/*.yaml vs frontend/src/)
- **Phase 4 (Polish)**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Phase 1, 2 –∏ 3

### Within User Story 1

- T001, T002 (—Ç–µ—Å—Ç—ã) ‚Üí T004, T005 (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ‚Äî TDD: —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞
- T003 (config fix) ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º, –º–æ–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å T001-T002

### Within User Story 2

- T006 (—Ç–µ—Å—Ç—ã) ‚Üí T007, T008 (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ‚Äî TDD: —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞
- T009 (AppHeader fix) ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç T007/T008

### Parallel Opportunities

- T001, T002, T003 –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã)
- T006 –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å T005 (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: client.test.ts vs auth.ts)
- T010, T011 –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –ª—é–±—ã–º–∏ frontend-–∑–∞–¥–∞—á–∞–º–∏ (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: config vs frontend)
- T009 –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å T007/T008 (—Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã: AppHeader.vue vs client.ts/LoginView.vue)

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. T001 + T002: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ fail
2. T003: –ò—Å–ø—Ä–∞–≤–∏—Ç—å cookie_secure –≤ stage-–∫–æ–Ω—Ñ–∏–≥–µ
3. T004: –î–æ–±–∞–≤–∏—Ç—å callback-–º–µ—Ö–∞–Ω–∏–∑–º –≤ interceptor
4. T005: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å callback –≤ store ‚Üí —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
5. **STOP –∏ VALIDATE**: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å refresh –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### Incremental Delivery

1. US1 (T001-T005) ‚Üí Refresh —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –º–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å
2. US2 (T006-T009) ‚Üí Redirect-back + logout fix ‚Üí –¥–µ–ø–ª–æ–π
3. US3 (T010-T011) ‚Üí TTL 2h ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π
4. Polish (T012-T014) ‚Üí –ü–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

---

## Notes

- –í—Å–µ–≥–æ **5 frontend —Ñ–∞–π–ª–æ–≤** –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã: `client.ts`, `auth.ts`, `LoginView.vue`, `AppHeader.vue`, `client.test.ts`, `auth.test.ts`
- –ü–ª—é—Å **4 config —Ñ–∞–π–ª–∞**: `config.stage.yaml`, `config.dev.yaml`, `config.prod.yaml`, `config.go`
- –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî 1-—Å—Ç—Ä–æ—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ config (`cookie_secure: false`)
- –í—Ç–æ—Ä–∏—á–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã ‚Äî ~20 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤–æ frontend
- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç vitest + vi.mock (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ client.test.ts)
- –ö–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
