# API Contract: Reader (контент книги)

**Feature**: 006-fb2-reader | **Date**: 2026-02-18

## Базовый путь

```
/api/books/:id
```

Все эндпоинты требуют JWT-аутентификации (заголовок `Authorization: Bearer <token>`).

---

## GET /api/books/:id/content

Возвращает метаданные и структуру книги (без текста глав).

### Параметры пути

| Параметр | Тип | Описание |
|----------|-----|----------|
| id | int64 | ID книги в каталоге |

### Успешный ответ (200 OK)

```json
{
  "metadata": {
    "title": "Мастер и Маргарита",
    "author": "Михаил Булгаков",
    "cover": "/api/books/123/cover",
    "language": "ru",
    "format": "fb2"
  },
  "toc": [
    {"id": "ch1", "title": "Часть первая", "level": 0},
    {"id": "ch1-1", "title": "Глава 1. Никогда не разговаривайте с неизвестными", "level": 1},
    {"id": "ch1-2", "title": "Глава 2. Понтий Пилат", "level": 1}
  ],
  "chapters": ["ch1", "ch1-1", "ch1-2"],
  "totalChapters": 32
}
```

### Поля ответа

| Поле | Тип | Описание |
|------|-----|----------|
| metadata.title | string | Название книги |
| metadata.author | string | Автор |
| metadata.cover | string \| null | URL обложки (null если нет) |
| metadata.language | string | Код языка (ISO 639-1) |
| metadata.format | string | Формат файла ("fb2") |
| toc[].id | string | ID элемента оглавления (совпадает с chapterId) |
| toc[].title | string | Название главы/секции |
| toc[].level | int | Уровень вложенности (0 = верхний) |
| chapters | string[] | Упорядоченный список ID глав |
| totalChapters | int | Общее количество глав |

### Ошибки

| Код | Описание |
|-----|----------|
| 401 | Не авторизован |
| 404 | Книга не найдена |
| 415 | Формат книги не поддерживается (не FB2) |
| 422 | Невалидный/повреждённый FB2-файл |
| 500 | Внутренняя ошибка сервера |

### Формат ошибки

```json
{
  "error": "unsupported_format",
  "message": "Формат epub пока не поддерживается для чтения в браузере"
}
```

---

## GET /api/books/:id/chapter/:chapterId

Возвращает HTML-контент одной главы (чистый HTML без стилей).

### Параметры пути

| Параметр | Тип | Описание |
|----------|-----|----------|
| id | int64 | ID книги |
| chapterId | string | ID главы из поля `chapters` |

### Успешный ответ (200 OK)

```json
{
  "id": "ch1-1",
  "title": "Глава 1. Никогда не разговаривайте с неизвестными",
  "html": "<h2 class=\"chapter-title\">Глава 1...</h2><p>Однажды весною...</p>"
}
```

### Поля ответа

| Поле | Тип | Описание |
|------|-----|----------|
| id | string | ID главы |
| title | string | Заголовок главы |
| html | string | Чистый HTML контент (классы для стилизации, без inline-стилей) |

### HTML-классы контента

| Класс | Элемент FB2 | Описание |
|-------|-------------|----------|
| `chapter-title` | `<title>` | Заголовок главы |
| `epigraph` | `<epigraph>` | Эпиграф (blockquote) |
| `epigraph-author` | `<text-author>` в эпиграфе | Автор эпиграфа |
| `poem` | `<poem>` | Стихотворение |
| `stanza` | `<stanza>` | Строфа |
| `verse` | `<v>` | Стихотворная строка |
| `poem-author` | `<text-author>` в стихе | Автор стихотворения |
| `subtitle` | `<subtitle>` | Подзаголовок |
| `cite` | `<cite>` | Цитата |
| `footnote-ref` | `<a type="note">` | Ссылка на сноску (атрибут `data-note-id`) |
| `footnote-body` | `<section>` в `<body name="notes">` | Тело сноски (атрибут `id`) |

### Ошибки

| Код | Описание |
|-----|----------|
| 401 | Не авторизован |
| 404 | Книга или глава не найдена |
| 422 | Невалидный FB2-файл |
| 500 | Внутренняя ошибка |

---

## GET /api/books/:id/image/:imageId

Возвращает изображение, встроенное в FB2-файл.

### Параметры пути

| Параметр | Тип | Описание |
|----------|-----|----------|
| id | int64 | ID книги |
| imageId | string | ID изображения из FB2 (`<binary>` id) |

### Успешный ответ (200 OK)

- **Content-Type**: `image/jpeg`, `image/png` или `image/gif` (в зависимости от `content-type` атрибута в FB2)
- **Body**: бинарные данные изображения
- **Cache-Control**: `public, max-age=86400` (24 часа)

### Ошибки

| Код | Описание |
|-----|----------|
| 401 | Не авторизован |
| 404 | Книга или изображение не найдено |
| 500 | Внутренняя ошибка |

---

## Кеширование

- Результат конвертации (BookContent + ChapterContent) кешируется на файловой системе
- Ключ кеша: `book:{bookID}:content` и `book:{bookID}:chapter:{chapterID}`
- TTL: нет (книги иммутабельны, кеш инвалидируется только при удалении книги из каталога)
- Путь: `{cache_dir}/books/{bookID}/`
- Изображения отдаются с заголовком `Cache-Control` для кеширования в браузере

## Примечания

- HTML в ответе главы содержит CSS-классы, но **без inline-стилей** — стилизация полностью на фронтенде
- Ссылки на изображения в HTML заменяются на `/api/books/:id/image/:imageId` вместо data URI
- Главы загружаются по одной (lazy loading) — фронтенд запрашивает следующую/предыдущую по мере навигации
