# Feature Specification: Браузерная читалка FB2

**Feature Branch**: `006-fb2-reader`
**Created**: 2026-02-18
**Status**: Draft
**Input**: Опираясь на архитектуру docs/homelib-architecture-v8.md нужно написать браузерную читалку. На первом этапе реализуем только чтение fb2.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Открытие и чтение книги FB2 (Priority: P1)

Пользователь находит книгу в каталоге, нажимает кнопку «Читать» и видит содержимое книги в браузере. Текст отображается с комфортной типографикой: красная строка, оптимальный шрифт и интервалы. Пользователь перелистывает страницы стрелками клавиатуры, кнопками на экране или свайпами (на мобильных устройствах). Навигация по оглавлению позволяет быстро перейти к нужной главе.

**Why this priority**: Без базового чтения вся читалка бесполезна. Это фундаментальная функция, на которой строятся все остальные.

**Independent Test**: Открыть любую книгу FB2 из каталога, убедиться что текст отображается корректно, перелистывание страниц работает, оглавление показывает структуру книги.

**Acceptance Scenarios**:

1. **Given** авторизованный пользователь на странице книги в каталоге, **When** он нажимает кнопку «Читать», **Then** открывается страница читалки с текстом книги
2. **Given** пользователь читает книгу, **When** он нажимает стрелку вправо / кнопку «Далее» / свайп влево, **Then** отображается следующая страница текста
3. **Given** пользователь читает книгу, **When** он нажимает стрелку влево / кнопку «Назад» / свайп вправо, **Then** отображается предыдущая страница текста
4. **Given** пользователь открыл читалку, **When** он нажимает кнопку оглавления, **Then** отображается иерархический список глав с возможностью перехода к выбранной главе
5. **Given** пользователь читает книгу с эпиграфами, стихами и цитатами, **When** отображается такой контент, **Then** эпиграфы выделены курсивом с отступом, стихи сохраняют построчное форматирование, цитаты отображаются с боковой линией
6. **Given** книга содержит встроенные изображения, **When** пользователь доходит до страницы с изображением, **Then** изображение отображается в тексте пропорционально ширине контента

---

### User Story 2 - Сохранение и восстановление прогресса чтения (Priority: P2)

Пользователь читает книгу, закрывает браузер, через некоторое время возвращается и продолжает чтение с того места, где остановился. Прогресс сохраняется автоматически, без явных действий пользователя.

**Why this priority**: Без сохранения прогресса пользователь каждый раз начинает сначала, что делает читалку непригодной для серьёзного использования.

**Independent Test**: Открыть книгу, прочитать несколько страниц, закрыть вкладку. Снова открыть ту же книгу — должна открыться на последнем месте.

**Acceptance Scenarios**:

1. **Given** пользователь читает книгу и перелистывает страницы, **When** прошло некоторое время после перелистывания, **Then** текущая позиция автоматически сохраняется
2. **Given** пользователь ранее читал книгу и закрыл браузер, **When** он снова открывает ту же книгу, **Then** читалка открывается на последней сохранённой позиции
3. **Given** пользователь находится на странице книги в каталоге и ранее начинал чтение, **When** он видит карточку/страницу книги, **Then** отображается индикатор прогресса (процент прочитанного)

---

### User Story 3 - Настройка внешнего вида читалки (Priority: P3)

Пользователь хочет настроить читалку под свои предпочтения: изменить размер и семейство шрифта, выбрать цветовую тему (светлая, сепия, тёмная, ночная, пользовательская), настроить межстрочный интервал, отступы и поля, включить авто-переносы. Настройки сохраняются и применяются при следующем открытии любой книги.

**Why this priority**: Комфорт чтения субъективен — одним удобны мелкие шрифты, другим крупные; ночью нужна тёмная тема. Без настроек часть пользователей не сможет комфортно читать.

**Independent Test**: Открыть книгу, изменить размер шрифта и тему, закрыть книгу, открыть другую — настройки должны сохраниться.

**Acceptance Scenarios**:

1. **Given** пользователь читает книгу, **When** он открывает панель настроек и изменяет размер шрифта, **Then** текст в читалке мгновенно перестраивается с новым размером
2. **Given** пользователь читает книгу, **When** он переключает тему на «тёмную», **Then** фон становится тёмным, текст светлым, ссылки — соответствующего цвета
3. **Given** пользователь изменил настройки читалки, **When** он закрывает и снова открывает любую книгу, **Then** настройки сохранены и применены
4. **Given** пользователь настроил межстрочный интервал и поля, **When** изменения применяются, **Then** текст перестраивается с новыми интервалами без потери текущей позиции чтения

---

### Edge Cases

- Что происходит, если книга FB2 повреждена или содержит невалидный XML? Система должна показать понятное сообщение об ошибке, а не пустую страницу
- Что происходит, если книга содержит только одну секцию без оглавления? Читалка должна работать без оглавления, показывая весь текст как одну непрерывную главу
- Что происходит при чтении книги на узком экране мобильного телефона? Текст должен корректно адаптироваться к ширине экрана, навигация работать через свайпы и тапы
- Что происходит, если формат книги не FB2 (например, epub)? Кнопка «Читать» не должна отображаться для неподдерживаемых форматов; кнопка «Скачать» доступна для всех форматов
- Что происходит при потере сети во время чтения? Текст уже загруженных глав остаётся доступным, при попытке перейти к незагруженной главе показывается сообщение об ошибке сети
- Что происходит, если книга очень большая (тысячи страниц)? Система загружает главы по требованию, а не всю книгу целиком
- Что происходит с inline-изображениями, встроенными в FB2 как base64? Они должны отображаться корректно

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА конвертировать книги формата FB2 в HTML на серверной стороне, возвращая чистый HTML без стилей
- **FR-002**: Система ДОЛЖНА разбивать книгу на главы в соответствии с секционной структурой FB2-файла
- **FR-003**: Система ДОЛЖНА предоставлять оглавление книги в виде иерархического списка с возможностью навигации к конкретной главе
- **FR-004**: Система ДОЛЖНА отображать FB2-специфичные элементы: эпиграфы, стихи (с построчным форматированием), цитаты, подзаголовки, сноски (inline-popup по тапу/клику на ссылку-сноску)
- **FR-005**: Система ДОЛЖНА отображать inline-изображения, встроенные в FB2-файл
- **FR-006**: Система ДОЛЖНА обеспечивать постраничную навигацию с разбиением текста на страницы в зависимости от размера окна и настроек шрифта
- **FR-007**: Система ДОЛЖНА поддерживать навигацию клавиатурой (стрелки, пробел, PageUp/PageDown), экранными кнопками и жестами (свайпы, тапы)
- **FR-008**: Система ДОЛЖНА автоматически сохранять позицию чтения при перелистывании (с задержкой для минимизации запросов)
- **FR-009**: Система ДОЛЖНА восстанавливать позицию чтения при повторном открытии книги
- **FR-010**: Система ДОЛЖНА поддерживать 5 цветовых тем: светлая, сепия, тёмная, ночная и пользовательская (custom — с настройкой цветов фона, текста, ссылок и выделения)
- **FR-011**: Система ДОЛЖНА позволять настраивать параметры отображения в соответствии с §8.5 архитектуры: шрифт (размер, семейство, насыщенность), интервалы (межстрочный, между абзацами, межбуквенный), отступы (горизонтальные и вертикальные поля, красная строка), текст (выравнивание, авто-переносы), режим (постраничный/скролл, анимация перелистывания), дополнительно (индикатор прогресса, часы, зоны тапа)
- **FR-012**: Система ДОЛЖНА сохранять настройки читалки в профиле пользователя и применять их при каждом открытии книги
- **FR-013**: Система ДОЛЖНА кешировать результат конвертации для повторных запросов
- **FR-014**: Система ДОЛЖНА загружать главы по требованию, а не весь контент книги сразу
- **FR-015**: Система ДОЛЖНА отображать кнопку «Читать» только для книг формата FB2 (в рамках данной итерации)
- **FR-016**: Система ДОЛЖНА показывать индикатор прогресса чтения (процент прочитанного) в нижней части читалки и на карточке книги в каталоге
- **FR-017**: Система ДОЛЖНА корректно обрабатывать повреждённые FB2-файлы, показывая понятное сообщение об ошибке

### Key Entities

- **Книжный контент (BookContent)**: Результат конвертации книги — метаданные (название, автор, язык, формат), оглавление (иерархический список глав), список идентификаторов глав
- **Глава (ChapterContent)**: Отдельная глава книги — идентификатор, заголовок, HTML-контент
- **Прогресс чтения (ReadingProgress)**: Позиция пользователя в книге — идентификатор главы, процент внутри главы, общий процент прочитанного, время последнего обновления
- **Настройки читалки (ReaderSettings)**: Пользовательские предпочтения — шрифт, размер, тема, интервалы, поля, режим отображения

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может открыть и прочитать книгу FB2 от начала до конца без ошибок или технических прерываний
- **SC-002**: Книга FB2 открывается для чтения в течение 3 секунд (от нажатия кнопки «Читать» до отображения первой страницы текста)
- **SC-003**: Позиция чтения восстанавливается с точностью до текущей главы при повторном открытии книги
- **SC-004**: Настройки читалки (шрифт, тема, интервалы) применяются мгновенно при изменении и сохраняются между сессиями
- **SC-005**: Читалка корректно отображается и управляется как на десктопе (клавиатура), так и на мобильных устройствах (свайпы, тапы)
- **SC-006**: Все FB2-специфичные элементы (эпиграфы, стихи, цитаты, изображения) отображаются корректно в соответствии с типографическими стандартами
- **SC-007**: Unit-тесты покрывают не менее 80% кода конвертера и компонентов читалки

### Assumptions

- Книги хранятся в ZIP-архивах и доступны через механизм чтения из архивов, реализованный в MVP
- Существующий каталог уже возвращает формат книги, что позволяет определить, доступна ли кнопка «Читать»
- Таблица хранения прогресса чтения описана в архитектуре, но ещё не создана — потребуется миграция
- Настройки читалки хранятся в поле пользовательских настроек, которое уже предусмотрено архитектурой
- На данном этапе поддерживается только формат FB2; EPUB, PDF, DJVU будут добавлены в следующих итерациях
- Кеширование конвертированного контента реализуется на файловой системе (без внешних сервисов кеширования на первом этапе)
